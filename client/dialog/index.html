<!doctype html>
<meta charset="utf-8">
<title>Topicmap</title>
<link rel="stylesheet" href="./style.css">

<body class="theme-light"><!-- LIGHT by default; plugin can send theme -->

  <header class="tm-head">
    <div class="tm-title">Topicmap</div>
    <div class="tm-actions">
      <button id="close">Close</button>
    </div>
  </header>

  <main class="tm-main">
    <iframe id="app" title="dm6-elm"
            sandbox="allow-scripts allow-same-origin"></iframe>
  </main>

  <script>
    function getParentOrigin() {
      const ref = document.referrer;
      if (ref) {
        try {
          return new URL(ref).origin;
        } catch (e) {
          return window.location.origin;
        }
      }
      return window.location.origin;
    }

    function isValidInitMessage(msg) {
      if (!msg || typeof msg !== 'object') return false;
      if (msg.kind !== 'topicmap:init') return false;
      if (msg.lineup && !Array.isArray(msg.lineup)) return false;
      if (msg.options && typeof msg.options !== 'object') return false;
      return true;
    }

    const app = document.getElementById('app');
    const params = new URLSearchParams(location.search);
    const DEFAULT_COLD_BOOT = '/assets/pages/cold-boot/cold-boot.html';
    const parentOrigin = getParentOrigin();

    // Guard to avoid double-forward on reloads
    let forwarded = false;

    window.addEventListener('message', evt => {
      // accept only expected-origin init messages
      if (evt.origin !== parentOrigin) return;
      const msg = evt.data || {};
      if (!isValidInitMessage(msg)) return;

      // theme hint
      const theme = (msg.options && msg.options.theme) || 'light';
      document.body.className = 'theme-' + theme; // theme-light|theme-dark|theme-auto

      // cold boot URL (query param wins)
      const coldBoot = params.get('coldBoot') || (msg.options && msg.options.coldBoot) || DEFAULT_COLD_BOOT;
      app.src = coldBoot;

      app.addEventListener('load', () => {
        if (forwarded) return;
        forwarded = true;
        try {
          // forward the same init payload to the app in the iframe
          app.contentWindow.postMessage(
            { kind: 'topicmap:init', lineup: msg.lineup, options: msg.options, from: window.location.origin },
            new URL(coldBoot, window.location.href).origin
          );
        } catch (e) {
          console.warn('Forward failed; will not retry.', e);
        }
      }, { once: true });
    });

    document.getElementById('close').addEventListener('click', () => {
      window.parent.postMessage({ kind: 'topicmap:close' }, parentOrigin);
    });
  </script>
</body>
